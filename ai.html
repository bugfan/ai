<html>

    <head>
        <title>AI</title>
        <script src="//libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        <script src="//cdn.bootcss.com/pagedown/1.0/Markdown.Converter.js"></script>

        <link href="//cdn.bootcss.com/toastr.js/latest/css/toastr.min.css" rel="stylesheet">

        <script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="//cdn.bootcss.com/toastr.js/latest/js/toastr.min.js"></script>
        <style> html { background:#F0FFFF;}</style

    </head>

    <body>
        <center>
            <br>
            <br>
            <h2 style="font-size:large;color:rgb(126, 16, 169);">ChatGPT3</h2>
            <a style="font-size: small;color: chocolate;"  href="https://github.com/bugfan">Github</a>
            <a style="font-size: small;color: chocolate;"  href="https://www.i996.me">å†…ç½‘ç©¿é€</a>
            <br/>
            <img style="margin-left:25px;" src="https://www.i996.me/img/qdmsj.png">
            <br/>
            <!-- <p class="hov">å¦‚æœTokenè®¾ç½®æ­£ç¡®ä¼šè‡ªåŠ¨ä¿å­˜</p> -->
            <div class="hovt" ><input id="token" placeholder="è¾“å…¥ğŸ‘†å…¬ä¼—å·Tokenåå¯è®¿é—®" style="width:190px" type="text" value="" /></div>
            <hr style="width: 300px;">
            <p style="font-size: small;color: chocolate;">è¾“å…¥é—®é¢˜åæ•²å›è½¦,æˆ–è€…ç‚¹å‡»ä¸‹é¢çš„â€œå‘é€â€æŒ‰é’®</p>
            <textarea id="text" type="text" style="width:210px;height: 80px;" ></textarea>
            <br/>
            <br/>
            <button id="btn2" style="background-color: rgb(194, 183, 28);" onclick="cls()">æ¸…ç©º</button>
            <button id="btn1" style="background-color: aqua;" onclick="ask()">å‘é€</button>
        </center>
        <center>
            <br/>
            <div id="load"><img style="width:100px;height:80px;" src="https://www.i996.me/img/load1.png" /></div>
            <div style="width: 500px;text-align: center;" id="content"></div>
        </center>

    </body>

    <script>
        var at = document.getElementById('text')
        at.onkeydown = function(e){
            if((e||event).keyCode==13)
                ask();
        };
        var tokenElement = document.getElementById('token')
        var localToken = localStorage.getItem('_qdmsj_token')
        if ( localToken != ''){
            tokenElement.value = localToken
        }

        var text = "ä½ å¥½.\n\n æ¬¢è¿ä½“éªŒäººå·¥æ™ºèƒ½èŠå¤©æœºå™¨äºº.";
        var converter = new Markdown.Converter();
        var html = converter.makeHtml(text);
        $("#content").html(html);

        var xhr=new XMLHttpRequest();  //new

        toastr.options = { // toastré…ç½®
            "closeButton": true, //æ˜¯å¦æ˜¾ç¤ºå…³é—­æŒ‰é’®
            "debug": false, //æ˜¯å¦ä½¿ç”¨debugæ¨¡å¼
            "progressBar": false, //æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œå½“ä¸ºfalseæ—¶å€™ä¸æ˜¾ç¤ºï¼›å½“ä¸ºtrueæ—¶å€™ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡ï¼Œå½“è¿›åº¦æ¡ç¼©çŸ­åˆ°0æ—¶å€™ï¼Œæ¶ˆæ¯é€šçŸ¥å¼¹çª—æ¶ˆå¤±
            "positionClass": "toast-top-center",//æ˜¾ç¤ºçš„åŠ¨ç”»æ—¶é—´
            "showDuration": "400", //æ˜¾ç¤ºçš„åŠ¨ç”»æ—¶é—´
            "hideDuration": "1000", //æ¶ˆå¤±çš„åŠ¨ç”»æ—¶é—´
            "timeOut": "2000", //å±•ç°æ—¶é—´
            "extendedTimeOut": "1000", //åŠ é•¿å±•ç¤ºæ—¶é—´
            "showEasing": "swing", //æ˜¾ç¤ºæ—¶çš„åŠ¨ç”»ç¼“å†²æ–¹å¼
            "hideEasing": "linear", //æ¶ˆå¤±æ—¶çš„åŠ¨ç”»ç¼“å†²æ–¹å¼
            "showMethod": "fadeIn", //æ˜¾ç¤ºæ—¶çš„åŠ¨ç”»æ–¹å¼
            "hideMethod": "fadeOut" //æ¶ˆå¤±æ—¶çš„åŠ¨ç”»æ–¹å¼
        }
        function cls(){
            document.getElementById('text').value = ''
        }
        function ask(){
            var info = document.getElementById('btn1').innerHTML
            if (info == 'ä¸­æ–­'){
                xhr.abort()
                free()
                return 
            }
            // toastr.error("è¿æ¥ä¸èƒ½æ‰“å¼€ï¼");
            // toastr.success("è¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥è¿›è¡Œé€šä¿¡ï¼")
            // toastr.success("è¿æ¥å·²å»ºç«‹ï¼Œå¯ä»¥è¿›è¡Œé€šä¿¡ï¼", "æˆåŠŸ")
            // toastr.warning("è¿æ¥å»ºç«‹å¤±è´¥ï¼Œè¯·é‡è¯•ï¼")
            // toastr.info("è¯·å…ˆç™»å½•ï¼")

            var token = tokenElement.value
            if (token == ''){
                toastr.info('å¡«å†™æ­£ç¡®Tokenåæ‰èƒ½è®¿é—®')
                return
            }

            var q = document.getElementById('text').value
            if (q == ''){
                toastr.info('è¯·è¾“å…¥é—®é¢˜åå†æäº¤')
                return
            }

            xhr.open('POST',"/ask",true);//
            xhr.setRequestHeader("Authorization", token);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            busy()
            xhr.send(JSON.stringify({content:q}));
            xhr.onreadystatechange=function(){
                if (xhr.readyState==4){
                    if (xhr.status==200){
                        // save current token to local storage
                        localStorage.setItem('_qdmsj_token',token)
                        var str = xhr.responseText
                        console.log(str);
                        var converter = new Markdown.Converter();
                        var html = converter.makeHtml(str);
                        $("#content").html(html);
                    }else if (xhr.status==403 || xhr.status==500 || xhr.status==202){
                        toastr.warning(xhr.responseText)
                    }
                }
                free()
            };
            xhr.onerror=function(){
                toastr.error("è¯·æ±‚å¼‚å¸¸");
                free()
            }
        }
        function busy(){
            document.getElementById('btn1').innerHTML = 'ä¸­æ–­'
            var load = document.getElementById('load')
            load.innerHTML = `<img style="width:100px;height:80px;" src="https://www.i996.me/img/load2.gif" />`
        }
        function free(){
            document.getElementById('btn1').innerHTML = 'å‘é€'
            var load = document.getElementById('load')
            load.innerHTML = `<img style="width:100px;height:80px;" src="https://www.i996.me/img/load1.png" />`
        }
    </script>
</html>
